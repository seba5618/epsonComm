package ar.com.bambu.communicator;


import ar.com.bambu.communicator.reply.AuditoriaJornadasFiscales;
import ar.com.bambu.communicator.reply.ConfiguracionFechayHora;
import ar.com.bambu.communicator.reply.InformacionDelEquipo;
import ar.com.bambu.communicator.reply.ReporteAfip;
import ar.com.bambu.serial.EpsonSerialChannel;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.jpos.iso.ISOUtil;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.MockitoJUnitRunner;

@RunWith(MockitoJUnitRunner.class)
public class EpsonCommunicatorTest {

    private static final Logger logger = LogManager.getLogger(EpsonCommunicatorTest.class);

    private EpsonCommunicator toTest = new EpsonCommunicator();

    @Mock
    private EpsonSerialChannel channel;

    @Before
    public void initialize(){


        this.toTest.setChannel(this.channel);
    }

    @Test
    public void testGetFecha() throws  Exception{
        logger.info("Test: Fecha Y Hora");

        String trama = "00001C" +
                "C0001C" +
                "1C" +
                "00001C" +
                "1C" +
                "3239303532311C" +
                "3231353134381C";
        byte[] bytes = ISOUtil.hex2byte(trama);
        Mockito.when(channel.sendMsg(Mockito.any(byte[].class))).thenReturn(bytes);
        ConfiguracionFechayHora fechaHora = this.toTest.getFechaHora();
        Assert.assertEquals("Fecha deberia ser: "+290521+". Pero es: "+fechaHora.getFecha(), "290521", fechaHora.getFecha() );
        Assert.assertEquals("Hora deberia ser: "+215148+". Pero es: "+fechaHora.getHora(), "215148", fechaHora.getHora()) ;
    }
    @Test
    public void testObtenerInformacionDelEquipo() throws  Exception{
        logger.info("Test: Obtener Informacion del Equipo");

        String trama = "00001C" +
                "C0001C" +
                "1C" +
                "00001C" +
                "1C" +
                "43657265731C" +
                "35341C" +
                "311C" +
                "301C" +
                "311C" +
                "34301C" +
                "746D743830301C" +
                "383338383630381C" +
                "33343230393739341C" +
                "3133313037321C" +
                "4E1C" +
                "001C";
        byte[] bytes = ISOUtil.hex2byte(trama);
        Mockito.when(channel.sendMsg(Mockito.any(byte[].class))).thenReturn(bytes);
        InformacionDelEquipo informacionEquipo = this.toTest.getInformacionEquipo();

    }

    @Test
    public void testObtenerAuditoriaDeJornadasFiscalesPorRangoDeCierreZ() throws  Exception{
        logger.info("Test: Obtener Auditoria Jornada por Rango de Z (no completo)");

        String trama = "00001C" +
                "C0401C" +
                "1C" +
                "00001C" +
                "1C" +
                "3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E3C746E733A61756469746F72696120786D6C6E733A746E733D22687474703A2F2F61722E676F622E616669702E636F6E74726F6C61646F7266697363616C2F636F6D70726F62616E7465735F61756469746F7269612220786D6C6E733A746E73313D22687474703A2F2F61722E676F622E616669702E636F6E74726F6C61646F7266697363616C2F616669702220786D6C6E733A746E73323D22687474703A2F2F61722E676F622E616669702E636F6E74726F6C61646F7266697363616C2F6369657272655F64696172696F5F7A2220786D6C6E733A7873693D22687474703A2F2F7777772E77332E6F72672F323030312F584D4C536368656D612D696E7374616E636522207873693A736368656D614C6F636174696F6E3D22687474703A2F2F61722E676F622E616669702E636F6E74726F6C61646F7266697363616C2F636F6D70726F62616E7465735F61756469746F72696120636F6D70726F62616E7465735F61756469746F7269612E787364223E3C656D69736F723E3C6E6F6D62726546616E7461736961456D69736F723E4E6F6D6272652066616E74617369612031204E6F6D6272652066616E74617369612032204E6F6D6272652066616E746173696120333C2F6E6F6D62726546616E7461736961456D69736F723E3C72617A6F6E536F6369616C456D69736F723E456C20547265626F6C20532E412E3C2F72617A6F6E536F6369616C456D69736F723E3C63756974456D69736F723E32333132333435363738353C2F63756974456D69736F723E3C646F6D6963696C696F436F6D65726369616C456D69736F723E446F6D6963696C696F20436F6D65726369616C20233120446F6D6963696C696F20436F6D65726369616C20233220446F6D6963696C696F20436F6D65726369616C2023333C2F646F6D6963696C696F436F6D65726369616C456D69736F723E3C61727261794964496D706F73697469766F73456D69736F723E3C646574616C6C654964496D706F73697469766F456D69736F723E3C6964496D706F73697469766F456D69736F723E30313C2F6964496D706F73697469766F456D69736F723E3C6172726179466563686173566967656E6369614964496D706F3E3C646574616C6C65466563686173566967656E6369614964496D706F3E3C6665636861486F726144657364653E323031352D30392D32355431353A32313A31373C2F6665636861486F726144657364653E3C6665636861486F726148617374613E323031352D30392D32355431353A32313A31373C2F6665636861486F726148617374613E3C2F646574616C6C65466563686173566967656E6369614964496D706F3E3C2F6172726179466563686173566967656E6369614964496D706F3E3C2F646574616C6C654964496D706F73697469766F456D69736F723E3C2F61727261794964496D706F73697469766F73456D69736F723E3C696962623E496E677265736F7320427275746F733C2F696962623E3C6665636861496E6963696F41637469766964616465733E313937392D30322D31303C2F6665636861496E6963696F41637469766964616465733E3C6E756D65726F50756E746F56656E74613E31323334353C2F6E756D65726F50756E746F56656E74613E3C2F656D69736F723E3C636F6E74726F6C61646F7246697363616C3E3C636F6469676F4661627269636143463E41423C2F636F6469676F4661627269636143463E3C636F6469676F4D6172636143463E43443C2F636F6469676F4D6172636143463E3C636F6469676F4D6F64656C6F43463E45463C2F636F6469676F4D6F64656C6F43463E3C6E756D65726F536572696543463E313233343536373839303C2F6E756D65726F536572696543463E3C76657273696F6E45717569706F3E563A2030312E30302043657265733C2F76657273696F6E45717569706F3E3C2F636F6E74726F6C61646F7246697363616C3E3C6665636861486F7261456D6973696F6E41756469746F7269613E323032312D30352D32395432313A35313A34383C2F6665636861486F7261456D6973696F6E41756469746F7269613E3C6172726179436F6D70726F62616E74657341756469746F7269613E3C636F6D70726F62616E746541756469746F7269613E3C72616E676F536F6C6963697461646F3E3C6E756D65726F5A44657364653E30303030303032313C2F6E756D65726F5A44657364653E3C6E756D65726F5A48617374613E30303030303032313C2F6E756D65726F5A48617374613E3C66656368615A44657364653E323031392D30352D31333C2F66656368615A44657364653E3C66656368615A48617374613E323031392D30352D31333C2F66656368615A48617374613E3C2F72616E676F536F6C6963697461646F3E3C72616E676F456E636F6E747261646F3E3C6E756D65726F5A44657364653E30303030303032313C2F6E756D65726F5A44657364653E3C6E756D65726F5A48617374613E30303030303032313C2F6E756D65726F5A48617374613E3C66656368615A44657364653E323031392D30352D31333C2F66656368615A44657364653E3C66656368615A48617374613E323031392D30352D31333C2F66656368615A48617374613E3C2F72616E676F456E636F6E747261646F3E3C6172726179436965727265735A3E1C" +
                "531C";
        byte[] bytes = ISOUtil.hex2byte(trama);
        Mockito.when(channel.sendMsg(Mockito.any(byte[].class))).thenReturn(bytes);
        AuditoriaJornadasFiscales auditoriaJornadasFiscales = this.toTest.getAuditoriaDeJornadasFiscalesPorRangoDeCierreZ(0,0,false);
        Assert.assertTrue("Tiene que estar marcado como incompleto el mensaje.", auditoriaJornadasFiscales.isPartialData());
    }

    @Test
    public void testReporteAfipPorFechaResumenDeTotales() throws  Exception{
        logger.info("Test: Obtener Reporte Afip Resumen de Totales");
        String tramaFirst = "00001C" +
                "C0501C" +
                "1C" +
                "00001C" +
                "1C" +
                "46383031312E32333132333435363738352E414243444546313233343536373839302E32303139303531332E6B68797970616D6D776D6D6C70656D7361776369737A7676637475676462727169726F7A2E70656D1C";

        String tramaLoop1 = "00001C" +
                "C0501C" +
                "1C" +
                "00001C" +
                "1C" +
                "2D2D2D2D2D424547494E20434D532D2D2D2D2D0A4D494147435371475349623344514548417143414D49414341514578435441484267557244674D43476A434142676B71686B69473977304242774767674353410A424949514144772F6547317349485A6C636E4E7062323439496A45754D4349675A57356A62325270626D6339496C565552693034496A382B50485275637A70680A64575270644739796157456765473173626E4D366447357A50534A6F644852774F693876595849755A3239694C6D466D615841755932397564484A766247466B0A62334A6D61584E6A595777765932397463484A76596D46756447567A583246315A476C3062334A705953496765473173626E4D366447357A4D543069614852300A63446F764C3246794C6D6476596935685A6D6C774C6D4E76626E5279623278685A4739795A6D6C7A593246734C32466D61584169494868746247357A4F6E52750A637A4939496D6830644841364C7939686369356E6232497559575A706343356A62323530636D397359575276636D5A7063324E686243396A61575679636D56660A5A476C68636D6C7658336F69494868746247357A4F6E687A615430696148523063446F764C336433647935334D793576636D63764D6A41774D533959545578540A5932686C625745746157357A64474675593255694948687A6154707A5932686C6257464D62324E6864476C76626A30696148523063446F764C3246794C6D64760A596935685A6D6C774C6D4E76626E5279623278685A4739795A6D6C7A593246734C324E766258427962324A68626E526C633139686457527064473979615745670A5932397463484A76596D46756447567A583246315A476C3062334A705953353463325169506A786C62576C7A6233492B5047357662574A795A555A68626E52680A63326C685257317063323979506B357662574A795A53426D5957353059584E70595341784945357662574A795A53426D5957353059584E7059534179494535760A62574A795A53426D5957353059584E705953417A5043397562323169636D56475957353059584E705955567461584E76636A3438636D46366232355462324E700A5957784662576C7A6233492B5257776756484A6C596D397349464D75515334384C334A68656D39755532396A615746735257317063323979506A786A64576C300A5257317063323979506A497A4D54497A4E4455324E7A67315043396A64576C305257317063323979506A786B6232317059326C73615739446232316C636D4E700A5957784662576C7A6233492B5247397461574E7062476C7649454E766257567959326C686243416A4D5342456232317059326C7361573867513239745A584A6A0A6157467349434D794945527662576C6A61577870627942446232316C636D4E7059577767497A4D384C32527662576C6A6157787062304E766257567959326C680A6245567461584E76636A343859584A7959586C4A5A456C746347397A61585270646D397A5257317063323979506A786B5A5852686247786C5357524A625842760A63326C3061585A765257317063323979506A78705A456C746347397A61585270646D394662576C7A6233492B4D4445384C326C6B5357317762334E7064476C320A6230567461584E76636A343859584A7959586C475A574E6F59584E576157646C626D4E7059556C6B53573177627A34385A475630595778735A555A6C593268680A63315A705A32567559326C685357524A62584276506A786D5A574E6F59556876636D46455A584E6B5A5434794D4445314C5441354C544931564445314F6A49780A4F6A45335043396D5A574E6F59556876636D46455A584E6B5A5434385A6D566A6147464962334A685347467A6447452B4D6A41784E5330774F5330794E5651780A4E546F794D546F784E7A77765A6D566A6147464962334A685347467A6447452B5043396B5A5852686247786C526D566A6147467A566D6C6E5A57356A6157464A0A5A456C746347382B50433968636E4A6865555A6C5932686863315A705A32567559326C685357524A62584276506A77765A475630595778735A556C6B535731770A62334E7064476C326230567461584E76636A34384C324679636D46355357524A6258427663326C3061585A766330567461584E76636A343861576C69596A354A0A626D64795A584E7663794243636E563062334D384C326C70596D492B50475A6C593268685357357059326C7651574E3061585A705A47466B5A584D2B4D546B330A4F5330774D6930784D4477765A6D566A6147464A626D6C6A6157394259335270646D6C6B5957526C637A3438626E56745A584A7655485675644739575A5735300A595434784D6A4D304E547776626E56745A584A7655485675644739575A573530595434384C32567461584E76636A34385932397564484A766247466B62334A470A61584E6A5957772B50474E765A476C6E62305A68596E4A7059324644526A3542516A77765932396B61576476526D4669636D6C6A59554E47506A786A623252700A5A32394E59584A6A59554E47506B4E455043396A623252705A32394E59584A6A59554E47506A786A623252705A32394E6232526C62473944526A3546526A77760A5932396B615764765457396B5A5778765130592B504735316257567962314E6C636D6C6C5130592B4D54497A4E4455324E7A67354D447776626E56745A584A760A5532567961575644526A3438646D567963326C76626B567864576C77627A35574F6941774D5334774D4342445A581C531C";

        String tramaLoop2 = "00001C" +
                "C0501C" +
                "1C" +
                "00001C" +
                "1C" +
                "4A6C637A7776646D567963326C76626B56780A64576C77627A34384C324E76626E5279623278685A473979526D6C7A59324673506A786D5A574E6F59556876636D464662576C7A615739755158566B615852760A636D6C68506A49774D6A45744D4455744D6A6C554D6A45364E5445364E4467384C325A6C59326868534739795955567461584E706232354264575270644739790A6157452B50474679636D46355132397463484A76596D46756447567A5158566B61585276636D6C68506A786A62323177636D3969595735305A5546315A476C300A62334A7059543438636D46755A3239546232787059326C3059575276506A786D5A574E6F595670455A584E6B5A5434794D4445354C5441314C5441345043396D0A5A574E6F595670455A584E6B5A5434385A6D566A614746615347467A6447452B4D6A41784F5330774E5330784E4477765A6D566A614746615347467A6447452B0A504339795957356E62314E7662476C6A615852685A47382B50484A68626D64765257356A62323530636D466B627A34385A6D566A614746615247567A5A47552B0A4D6A41784F5330774E5330784D7A77765A6D566A614746615247567A5A47552B50475A6C59326868576B686863335268506A49774D546B744D4455744D544D380A4C325A6C59326868576B686863335268506A7776636D46755A323946626D4E76626E527959575276506A7868636E4A6865554E705A584A795A584E61506A77760A59584A7959586C4461575679636D567A576A343859584A7959586C48636E567762334E4462323177636D3969595735305A584E4761584E6A5957786C637A34380A5A334A316347394462323177636D3969595735305A584E4761584E6A5957786C637A34385932396B6157647656476C7762304E766258427962324A68626E526C0A506A41344D6A77765932396B6157647656476C7762304E766258427962324A68626E526C506A78306158427653474669615778706447466A61573975513239740A63484A76596D46756447552B4D54777664476C7762306868596D6C736158526859326C76626B4E766258427962324A68626E526C506A7868636E4A6865554E760A626D7031626E527663304E766258427962324A68626E526C63305A7063324E686247567A526D566A6147467A506A786A623235716457353062304E76625842790A62324A68626E526C63305A7063324E686247567A526D566A6147467A506A786D5A574E6F59556876636D46455A584E6B5A5434794D4445314C5441354C5449310A564445314F6A49784F6A45335043396D5A574E6F59556876636D46455A584E6B5A5434385A6D566A6147464962334A685347467A6447452B4D6A41784E5330770A4F5330794E5651784E546F794D546F784E7A77765A6D566A6147464962334A685347467A6447452B504842796157316C636B35316257567962304E76625842790A62324A68626E526C506A41774D4441774D44597850433977636D6C745A584A4F6457316C636D394462323177636D3969595735305A54343864577830615731760A546E56745A584A765132397463484A76596D46756447552B4D4441774D4441774E6A59384C33567364476C74623035316257567962304E766258427962324A680A626E526C506A786A59573530615752685A454E766258427962324A68626E526C637A34325043396A59573530615752685A454E766258427962324A68626E526C0A637A34386157317762334A305A5652766447467352334A68646D466B627A34784E4449794C6A4D795043397062584276636E526C5647393059577848636D46320A59575276506A787062584276636E526C564739305957784F6230647959585A685A47382B4D4477766157317762334A305A56527664474673546D3948636D46320A59575276506A787062584276636E526C5647393059577846654756756447382B4D4477766157317762334A305A565276644746735258686C626E5276506A78680A636E4A6865564E31596E5276644746735A584E4A566B452B50484E31596E52766447467353565A42506A787762334A6A5A5735305957706C53565A42506A49780A4C6A41775043397762334A6A5A5735305957706C53565A42506A787062584276636E526C506A49354F4334334D4477766157317762334A305A5434384C334E310A596E52766447467353565A42506A777659584A7959586C5464574A30623352686247567A53565A42506A7868636E4A6865553930636D397A56484A70596E56300A62334D2B50433968636E4A6865553930636D397A56484A70596E563062334D2B50476C746347397964475655623352686245526C63324E315A57353062334E440A623251354F5434744D5445304C6A4D345043397062584276636E526C56473930595778455A584E6A645756756447397A5132396B4F546B2B50476C74634739790A644756556233526862454E766258427962324A68626E526C637A34784E7A49784C6A41795043397062584276636E526C564739305957784462323177636D39690A595735305A584D2B50474E68626E52705A47466B5132397463484A76596D46756447567A513246755932567359575276637A34775043396A59573530615752680A5A454E766258427962324A68626E526C63304E68626D4E6C6247466B62334D2B5043396A623235716457353062304E766258427962324A68626E526C63305A700A63324E686247567A526D566A6147467A506A777659584A7959586C44623235716457353062334E4462323177636D391C531C";

        String tramaLoop3 = "00001C" +
                "C0501C" +
                "1C" +
                "00001C" +
                "1C" +
                "69595735305A584E4761584E6A5957786C0A63305A6C59326868637A34384C326479645842765132397463484A76596D46756447567A526D6C7A593246735A584D2B50476479645842765132397463484A760A596D46756447567A526D6C7A593246735A584D2B50474E765A476C6E623152706347394462323177636D3969595735305A5434774F444D384C324E765A476C6E0A623152706347394462323177636D3969595735305A54343864476C7762306868596D6C736158526859326C76626B4E766258427962324A68626E526C506A45380A4C3352706347394959574A7062476C3059574E706232354462323177636D3969595735305A54343859584A7959586C44623235716457353062334E44623231770A636D3969595735305A584E4761584E6A5957786C63305A6C59326868637A343859323975616E56756447394462323177636D3969595735305A584E4761584E6A0A5957786C63305A6C59326868637A34385A6D566A6147464962334A685247567A5A47552B4D6A41784E5330774F5330794E5651784E546F794D546F784E7A77760A5A6D566A6147464962334A685247567A5A47552B50475A6C59326868534739795955686863335268506A49774D5455744D446B744D6A56554D5455364D6A45360A4D5463384C325A6C59326868534739795955686863335268506A7877636D6C745A584A4F6457316C636D394462323177636D3969595735305A5434774D4441770A4D4445314E6A777663484A7062575679546E56745A584A765132397463484A76596D46756447552B5048567364476C74623035316257567962304E76625842790A62324A68626E526C506A41774D4441774D54553250433931624852706257394F6457316C636D394462323177636D3969595735305A5434385932467564476C6B0A5957524462323177636D3969595735305A584D2B4D5477765932467564476C6B5957524462323177636D3969595735305A584D2B50476C7463473979644756550A623352686245647959585A685A47382B4D7A49354C6A63315043397062584276636E526C5647393059577848636D463259575276506A787062584276636E526C0A564739305957784F6230647959585A685A47382B4D4477766157317762334A305A56527664474673546D3948636D463259575276506A787062584276636E526C0A5647393059577846654756756447382B4D4477766157317762334A305A565276644746735258686C626E5276506A7868636E4A6865564E31596E5276644746730A5A584E4A566B452B50484E31596E52766447467353565A42506A787762334A6A5A5735305957706C53565A42506A49784C6A41775043397762334A6A5A5735300A5957706C53565A42506A787062584276636E526C506A59354C6A49315043397062584276636E526C506A777663335669644739305957784A566B452B504339680A636E4A6865564E31596E5276644746735A584E4A566B452B50474679636D46355433527962334E55636D6C6964585276637A34384C324679636D4635543352790A62334E55636D6C6964585276637A34386157317762334A305A565276644746735247567A5933566C626E527663304E765A446B35506A41384C326C74634739790A64475655623352686245526C63324E315A57353062334E44623251354F5434386157317762334A305A565276644746735132397463484A76596D46756447567A0A506A4D354F5334774D4477766157317762334A305A565276644746735132397463484A76596D46756447567A506A786A59573530615752685A454E76625842790A62324A68626E526C63304E68626D4E6C6247466B62334D2B4D4477765932467564476C6B5957524462323177636D3969595735305A584E445957356A5A5778680A5A47397A506A777659323975616E56756447394462323177636D3969595735305A584E4761584E6A5957786C63305A6C59326868637A34384C324679636D46350A51323975616E56756447397A5132397463484A76596D46756447567A526D6C7A593246735A584E475A574E6F59584D2B5043396E636E567762304E76625842790A62324A68626E526C63305A7063324E686247567A506A777659584A7959586C48636E567762334E4462323177636D3969595735305A584E4761584E6A5957786C0A637A34385932467564476C6B5957524462323177636D3969595734456767634F6447567A526D6C7A593246735A584D2B4E7A77765932467564476C6B595752440A62323177636D3969595735305A584E4761584E6A5957786C637A34386447393059577848636D4632595752765132397463484A76596D46756447567A526D6C7A0A593246735A584D2B4D5463314D6934774E7A77766447393059577848636D4632595752765132397463484A76596D46756447567A526D6C7A593246735A584D2B0A5048527664474673546D3948636D4632595752765132397463484A76596D46756447567A526D6C7A593246735A584D2B4D447776644739305957784F623064790A59585A685A47394462323177636D3969595735305A584E4761584E6A5957786C637A34386447393059577846654756756447394462323177636D3969595735300A5A584E4761584E6A5957786C637A34775043393062335268624556345A57353062304E766258427962324A68626E526C63305A7063324E686247567A506A78680A636E4A6865564E31596E5276644746735A584E4A566B452B50484E31596E52766447467353565A42506A787762334A6A1C531C";

        String tramaLoop4 = "00001C" +
                "C0501C" +
                "1C" +
                "00001C" +
                "1C" +
                "5A5735305957706C53565A42506A49780A4C6A41775043397762334A6A5A5735305957706C53565A42506A787062584276636E526C506A4D324E7934354E5477766157317762334A305A5434384C334E310A596E52766447467353565A42506A777659584A7959586C5464574A30623352686247567A53565A42506A7868636E4A6865553930636D397A56484A70596E56300A62334D2B50433968636E4A6865553930636D397A56484A70596E563062334D2B50485276644746735247567A5933566C626E527663304E765A446B35513239740A63484A76596D46756447567A526D6C7A593246735A584D2B4C5445784E43347A4F44777664473930595778455A584E6A645756756447397A5132396B4F546C440A62323177636D3969595735305A584E4761584E6A5957786C637A34386157317762334A305A565276644746735132397463484A76596D46756447567A526D6C7A0A593246735A584D2B4D6A45794D4334774D6A77766157317762334A305A565276644746735132397463484A76596D46756447567A526D6C7A593246735A584D2B0A50474E68626E52705A47466B5132397463484A76596D46756447567A513246755932567359575276637A34775043396A59573530615752685A454E76625842790A62324A68626E526C63304E68626D4E6C6247466B62334D2B50474679636D463551323975616E56756447397A5132397463484A76596D46756447567A546D39470A61584E6A53473974627A343859323975616E56756447394462323177636D3969595735305A584E4F62305A7063324E6853473974627A34385932396B615764760A56476C7762304E766258427962324A68626E526C506A6B304D5477765932396B6157647656476C7762304E766258427962324A68626E526C506A7877636D6C740A5A584A4F6457316C636D394462323177636D3969595735305A5434774D4441774D4441774D6A777663484A7062575679546E56745A584A765132397463484A760A596D46756447552B5048567364476C74623035316257567962304E766258427962324A68626E526C506A41774D4441774D44417950433931624852706257394F0A6457316C636D394462323177636D3969595735305A5434385932467564476C6B5957524462323177636D3969595735305A584D2B4D5477765932467564476C6B0A5957524462323177636D3969595735305A584D2B5043396A623235716457353062304E766258427962324A68626E526C63303576526D6C7A59324649623231760A506A786A623235716457353062304E766258427962324A68626E526C63303576526D6C7A5932464962323176506A786A623252705A32395561584276513239740A63484A76596D46756447552B4F544D325043396A623252705A323955615842765132397463484A76596D46756447552B504842796157316C636B3531625756790A62304E766258427962324A68626E526C506A41774D4441774D44417950433977636D6C745A584A4F6457316C636D394462323177636D3969595735305A5434380A6457783061573176546E56745A584A765132397463484A76596D46756447552B4D4441774D4441774D4449384C33567364476C74623035316257567962304E760A6258427962324A68626E526C506A786A59573530615752685A454E766258427962324A68626E526C637A34785043396A59573530615752685A454E76625842790A62324A68626E526C637A34384C324E76626D7031626E52765132397463484A76596D46756447567A546D394761584E6A595568766257382B50474E76626D70310A626E52765132397463484A76596D46756447567A546D394761584E6A595568766257382B50474E765A476C6E623152706347394462323177636D3969595735300A5A5434354D6A4D384C324E765A476C6E623152706347394462323177636D3969595735305A54343863484A7062575679546E56745A584A765132397463484A760A596D46756447552B4D4441774D4441774D4445384C3342796157316C636B35316257567962304E766258427962324A68626E526C506A7831624852706257394F0A6457316C636D394462323177636D3969595735305A5434774D4441774D4441774D5477766457783061573176546E56745A584A765132397463484A76596D46750A6447552B50474E68626E52705A47466B5132397463484A76596D46756447567A506A45384C324E68626E52705A47466B5132397463484A76596D46756447567A0A506A777659323975616E56756447394462323177636D3969595735305A584E4F62305A7063324E6853473974627A34384C324679636D463551323975616E56750A6447397A5132397463484A76596D46756447567A546D394761584E6A53473974627A34386157317762334A305A565276644746735132397463484A76596D46750A6447567A546D394761584E6A53473974627A34775043397062584276636E526C564739305957784462323177636D3969595735305A584E4F62305A7063324E490A62323176506A786A59573530615752685A454A73623346315A57397A506A41384C324E68626E52705A47466B516D78766358566C62334D2B5043396A623231770A636D3969595735305A5546315A476C3062334A70595434384C324679636D46355132397463484A76596D46756447567A5158566B61585276636D6C68506A786A0A623252705A323955615842765357356D556D5677506A6B774E5477765932396B6157647656476C7762306C755A6C4A6C631C531C";

        String tramaLoop5 = "00001C" +
                "C0501C" +
                "1C" +
                "00001C" +
                "1C" +
                "4434384C335275637A7068645752700A644739796157452B41414141414141416F494947307A434341306377676749766F414D4341514943415149774451594A4B6F5A496876634E41514546425141770A5044454C4D416B474131554542684D43515649784454414C42674E564241674D42454A7A51584D78446A414D42674E5642416F4D42555677633239754D5134770A444159445651514444415679623239304D544165467730784E4441784D4445774D4441774D444261467730304E4445794D7A45794D7A55354E546C614D4541780A437A414A42674E5642415954416B46534D5130774377594456515149444152436330467A4D513477444159445651514B4441564663484E76626A45534D4241470A413155454177774A59575A70634639305A584E304D494942496A414E42676B71686B6947397730424151454641414F43415138414D49494243674B43415145410A77706A3379346B36416E6D3777384A346E7271706D496B317377683137587435533465634A7731655353392F476C435665366B4D6552744C6E365232764831550A6C685277445444684B5637594E74386C76737A386F78765A525764375855584C386843776F686B6B74532B4173665752574F42764F54634F674B63584C424F680A644746434978544D72564D4F5154666C387353624D4D7A464D38517A6747657568383572386150694D50724E53735A66343441636E36533971434C727A4A71570A57657A357A794939634D342F4373444E5474594766384162692B71696A59475A2B4D77526251752B507142544A424943523357464A414D4B5372494A504650500A364C506679716D306F5048754C4550706151722F39414B3442635078366565354A4A373176456E5941686E583242326F5358694E354D357457747857766E73560A54516C657550586847373437635772783056555A6A774944415141426F314177546A416442674E56485134454667515538394A5073794C785A2B594F447A41560A787758424F37584A614D6777487759445652306A42426777466F4155684246514B735468765649753472456E574166656D5A535753376B7744415944565230540A42415577417745422F7A414E42676B71686B6947397730424151554641414F43415145414F346E767079366C2B793971672B3266584E4E416250674961772F6F0A2B52554D5273322F6A79467874792B304C516B6F7469526734674856316D726258395232593853754D674475695A46685951304E6F6859664544356A747148420A2F494C617748677A725636567534684C6B342F574439346B57614E39626432674561757867487958797564584B546E3557384543436A714B62504A7865745A6F0A704C4A65664F5836766F4E7A44706452696344674A385938594B7A69577A6E6D43543634327175696751313375457034445A4262424969556963772B6A5264360A30664C2F6C527064307034494373564C6B3676636F526B7358747A765078327732545A3837643878525665616835414F5772416835326D6442716466444568360A6F674A56724A73584131584C4E74516D37683442446E68647461567058664770646E31645552487A663274336E614962485A414A4A42594537544343413451770A67674A736F414D4341514943415173774451594A4B6F5A496876634E41514546425141775144454C4D416B474131554542684D43515649784454414C42674E560A4241674D42454A7A51584D78446A414D42674E5642416F4D42555677633239754D524977454159445651514444416C685A6D6C775833526C633351774868634E0A4D5451774D5441784D4441774D4441775768634E4D6A51784D6A4D784D6A4D314F545535576A424F4D517377435159445651514745774A42556A454E4D4173470A4131554543417745516E4E42637A454F4D41774741315545436777465258427A623234784944416542674E5642414D4D463056685A32786C55477831637A49770A4D5455774F5449314D544D314E5441324D494942496A414E42676B71686B6947397730424151454641414F43415138414D49494243674B4341514541704D54630A78737659737249315958716E7567395778526D37783963555159554E6B447646566B49575446526E2B39706A414F6C666C4D6379374E6642356439457A3043540A714C743139676E6F51486F77436F36694D6F4D4F714B6C713449525269644D755433567667675A6569544C746B61534171543069573141467A6738447845556C0A4F4C7A71757835375A4B3153373571457853714F364278504B53356C7744756E456A704478515236684B2F4F576139726559546D6451714248596155564163410A577472564475744749484B704A707365516739316A494152735648617247497450763967584E684E2B62376335484C692B4C684E5573614866634958573349500A7A6952397965435A4A427772306974354767756945507969776D66674858334C2F68472F557567397048697264576255645930696B325047656A3042746E69670A6D48375547513646422F74424E6679502F774944415141426F3373776554414A42674E5648524D45416A41414D43774743574347534147472B454942445151660A466831506347567555314E4D4945646C626D56795958526C5A4342445A584A3061575A70593246305A54416442674E564851344546675155586B6F5A4B3073610A774B63334E3232464C314B7053692F532F526B77487759445652306A42426777466F415538394A5073794C785A2B594F447A1C531C";

        String tramaLoop6 = "00001C" +
                "C0501C" +
                "1C" +
                "00001C" +
                "1C" +
                "4156787758424F37584A614D67770A4451594A4B6F5A496876634E415145464251414467674542414D4548566743544432793169445966546133687339586B6F516A377978724F7A4252786E4369370A6A4C37324B575662444A35494E336230716C7A7A684E7564636762647839586F6C706F7A6E694D4B51796E365550465971637348796642396C31776E4646657A0A504738532B4E535579436E64426B6142454A77484E775651785671515738782B43486A546C6F5A7831324D4761345A6F683573445242433445724274536E7A650A3149676C4467656473454564724C454E4F326F344D58586858685436534C7A6C68705A62737277464854496D4C574B4B51444F44305935765A313664656564670A61623245467A4669784A4D57456A4F6141435336715857476872394F315A4B64794B37524E346E56754743494D4D6F333378446F334B7757393030734C7161540A4D466F38304A654271696F754264785137546158694D47754269666D7950436B68424E6C45557A5A432B48646A45347867674A464D49494351514942415442460A4D454178437A414A42674E5642415954416B46534D5130774377594456515149444152436330467A4D513477444159445651514B4441564663484E76626A45530A4D424147413155454177774A59575A70634639305A584E304167454C4D4163474253734F417749616F4948594D42674743537147534962334451454A417A454C0A42676B71686B694739773042427745774841594A4B6F5A496876634E41516B464D513858445449784D44557A4D4441774E5445304F466F774977594A4B6F5A490A6876634E41516B454D525945464B30374B7A6D7338762B4A695A6836436E5549576A7846677854694D486B4743537147534962334451454A447A46734D476F770A4377594A59495A4941575544424145714D417347435743475341466C41775142466A414C42676C67686B67425A514D4541514977436759494B6F5A496876634E0A41776377446759494B6F5A496876634E41774943416743414D413047434371475349623344514D43416746414D4163474253734F417749484D413047434371470A5349623344514D434167456F4D413047435371475349623344514542415155414249494241492F355156336F6D59396D7A30524E6E3743534A704A6A356A2F710A51667532396D7436304A41542F4D36494769487A642F6663474F56352F507353382F4C3835722B414F37314530575078646C6765764A677855636E366C62366E0A2F4D664343574249673530474E64476872445972784B4544422F52567649325A396C70464C6A4F774B4D35587730636579797779616F4E63382F47564541686A0A454F56785A33766C414F725855642B354E774441304474574638326C6C5A3862776F5A2B4E555765416A344F2F4C7137714F382B546D6D7A6F6D6751556D49300A5A34624477422F54554F344C2B4735576831346F58723054593870773535335079576E4E3732597736333235755650502B3348646A736E43786C3155335957590A54557A674748686A38642B5A546D554E2B3769594B5579307435656170424C56664E54446744727870586F676D34502F6564696E6A4C4A4576767741414141410A4141413D0A2D2D2D2D2D454E4420434D532D2D2D2D2D0A1C531C";

        String tramaLoop7 = "00001C" +
                "C0501C" +
                "1C" +
                "00001C" +
                "1C" +
                "1C" +
                "4E1C";

        String tramaLast = "00001C" +
                "C0001C" +
                "1C" +
                "00001C" +
                "1C";

        Mockito.when(channel.sendMsg(Mockito.any(byte[].class)))
                .thenReturn(ISOUtil.hex2byte(tramaFirst))
                .thenReturn(ISOUtil.hex2byte(tramaLoop1))
                .thenReturn(ISOUtil.hex2byte(tramaLoop2))
                .thenReturn(ISOUtil.hex2byte(tramaLoop3))
                .thenReturn(ISOUtil.hex2byte(tramaLoop4))
                .thenReturn(ISOUtil.hex2byte(tramaLoop5))
                .thenReturn(ISOUtil.hex2byte(tramaLoop6))
                .thenReturn(ISOUtil.hex2byte(tramaLoop7))
                .thenReturn(ISOUtil.hex2byte(tramaLast));


        ReporteAfip reporte = this.toTest.getReporteAfipPorRangoDeFechas(new byte[]{0x00,0x04}, "050505","050505");
        Assert.assertFalse("Tiene que estar marcado como completo el mensaje", reporte.isPartialData());
        Assert.assertEquals("El nombre del archivo de afip no es el esperado: ", "F8011.23123456785.ABCDEF1234567890.20190513.khyypammwmmlpemsawciszvvctugdbrqiroz.pem", reporte.getFileName());
        Assert.assertTrue("Archivo encriptado debe empezar con encabezado: ", reporte.getDataHex().startsWith("-----BEGIN CMS-----"));
        Assert.assertTrue("Archivo encriptado debe terminar con pie: "+reporte.getDataHex(), reporte.getDataHex().endsWith("-----END CMS-----\n"));
        logger.info("Archivo encriptado: "+reporte.getDataHex());
    }

}